<!DOCTYPE html>
<html>
<head>
    <title>portfolio-pivot-table</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null,types=["PortfolioItem/Feature","PortfolioItem/Initiative"];Ext.define("CustomApp",{extend:"Rally.app.App",settingsScope:"app",componentCls:"app",config:{defaultSettings:{rows:"Initiative",cols:"InvestmentCategory"}},launch:function(){app=this;var panel=Ext.create("Ext.container.Container",{itemId:"panel",title:"Hello",html:"<p></p>"});app.settingsRows=app.getSetting("rows"),app.settingsCols=app.getSetting("cols"),this.add(panel);var p=this.down("#panel");app.jqPanel="#"+p.id,app.mask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.mask.show(),app.loadProjects()},getSettingsFields:function(){return[{name:"rows",xtype:"rallytextfield"},{name:"cols",xtype:"rallytextfield"}]},loadProjects:function(){var configs=[{model:"Project",fetch:["Name","ObjectID"]}];async.map(configs,app.wsapiQuery,function(err,results){app.projects=results[0],app.readPortfolioItems()})},createConfigForPortfolioType:function(type){var projects=_.map(app.projects,function(p){return p.get("ObjectID")});return{fetch:["Name","_UnformattedID","ObjectID","_TypeHierarchy","c_STO","_ItemHierarchy","InvestmentCategory","PortfolioItemType","State","Owner","Project","Parent"],hydrate:["_TypeHierarchy","State","PortfolioItemType","InvestmentCategory"],pageSize:1e3,find:{_TypeHierarchy:{$in:[type]},Project:{$in:projects},__At:"current"}}},readPortfolioItems:function(){var configs=_.map(types,function(type){return app.createConfigForPortfolioType(type)});async.mapSeries(configs,app.readSnapshots,function(err,results){app.addThemesToFeatures(results[0],results[1])})},addThemesToFeatures:function(features,initiatives){app.addOwners(features),app.addTeamNames(features),_.each(features,function(f){var initiative=_.find(initiatives,function(i){return f.get("Parent")===i.get("ObjectID")});f.set("Initiative",initiative?initiative.get("Name"):"None")})},cleanUpFieldNames:function(features){return _.each(features,function(f,i){var keys=_.keys(f);keys=_.filter(keys,function(k){return"c_"===k.substring(0,2)}),_.each(keys,function(k){var newKey=k.substring(2);f[newKey]=f[k],delete f[k]})}),features},addTeamNames:function(features){_.each(features,function(f){var p=_.find(app.projects,function(pr){return pr.get("ObjectID")===f.get("Project")});f.set("Team",p.get("Name"))}),app.pivotTable(features)},addOwners:function(features){var ownerIds=_.map(features,function(f){var o=f.get("Owner");return void 0!==o&&null!==o?o:null});ownerIds=_.compact(ownerIds),ownerIds=_.uniq(ownerIds);var configs=_.map(ownerIds,function(o){return{model:"User",fetch:["UserName","DisplayName"],filters:[{property:"ObjectID",value:o}]}});async.map(configs,app.wsapiQuery,function(err,results){app.owners=_.pluck(results,function(r){return r[0]}),app.owners=_.compact(app.owners),_.each(features,function(f){var ownerName=_.find(app.owners,function(o){return o.get("ObjectID")===f.get("Owner")});void 0!==ownerName&&null!==ownerName?f.set("OwnerName",null!==ownerName.get("DisplayName")&&ownerName.get("DisplayName").length>0?ownerName.get("DisplayName"):ownerName.get("UserName")):f.set("OwnerName","")}),app.addTeamNames(features)})},pivotTable:function(features){var rows=app.settingsRows.split(","),cols=app.settingsCols.split(",");console.log("rows:",rows,"cols:",cols);var data=_.map(features,function(s){return s.data});data=app.cleanUpFieldNames(data);var initDeriver=function(record){return record.Initiative},ownerDeriver=function(record){return record.OwnerName},derived={Initiative:initDeriver,OwnerName:ownerDeriver};$(app.jqPanel).pivotUI(data,{derivedAttributes:derived,cols:cols,rows:rows,hiddenAttributes:["Project","Owner","ObjectID","_TypeHierarchy","_UnformattedID","_ValidFrom","_ValidTo","PortfolioItemType","_ItemHierarchy"]}),app.mask.hide()},readSnapshots:function(config,callback){console.log("reading page of snapshots...");var storeConfig={find:config.find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:config.fetch,hydrate:config.hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});
                (function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y=[].slice,b=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},w=this,E={}.hasOwnProperty,S=function(e,t){return function(){return e.apply(t,arguments)}};e=jQuery,n=function(e,t,n){var r,i,s,o;for(e+="",i=e.split("."),s=i[0],o=i.length>1?n+i[1]:"",r=/(\d+)(\d{3})/;r.test(s);)s=s.replace(r,"$1"+t+"$2");return s+o},p=function(e,t,r,i){return null==e&&(e=3),null==t&&(t=1),null==r&&(r=","),null==i&&(i="."),function(s){return 0===s||isNaN(s)||!isFinite(s)?"":n((t*s).toFixed(e),r,i)}},r={sum:function(e,t){return null==e&&(e=3),null==t&&(t=1),function(n){var r;return r=n[0],function(){return{sum:0,push:function(e){return isNaN(parseFloat(e[r]))?void 0:this.sum+=parseFloat(e[r])},value:function(){return this.sum},format:p(e,t),label:"Sum of "+r}}}},average:function(e,t){return null==e&&(e=3),null==t&&(t=1),function(n){var r;return r=n[0],function(){return{sum:0,len:0,push:function(e){return isNaN(parseFloat(e[r]))?void 0:(this.sum+=parseFloat(e[r]),this.len++)},value:function(){return this.sum/this.len},format:p(e,t),label:"Average of "+r}}}},sumOverSum:function(e,t){return null==e&&(e=3),null==t&&(t=1),function(n){var r,i;return i=n[0],r=n[1],function(){return{sumNum:0,sumDenom:0,push:function(e){return isNaN(parseFloat(e[i]))||(this.sumNum+=parseFloat(e[i])),isNaN(parseFloat(e[r]))?void 0:this.sumDenom+=parseFloat(e[r])},value:function(){return this.sumNum/this.sumDenom},format:p(e,t),label:""+i+"/"+r}}}},sumOverSumBound80:function(e,t,n){return null==e&&(e=3),null==t&&(t=1),null==n&&(n=!0),function(r){var i,s;return s=r[0],i=r[1],function(){return{sumNum:0,sumDenom:0,push:function(e){return isNaN(parseFloat(e[s]))||(this.sumNum+=parseFloat(e[s])),isNaN(parseFloat(e[i]))?void 0:this.sumDenom+=parseFloat(e[i])},value:function(){var e;return e=n?1:-1,(.821187207574908/this.sumDenom+this.sumNum/this.sumDenom+1.2815515655446004*e*Math.sqrt(.410593603787454/(this.sumDenom*this.sumDenom)+this.sumNum*(1-this.sumNum/this.sumDenom)/(this.sumDenom*this.sumDenom)))/(1+1.642374415149816/this.sumDenom)},format:p(e,t),label:""+(n?"Upper":"Lower")+" Bound of "+s+"/"+i}}}},fractionOf:function(e,t){return null==t&&(t="total"),function(){var n;return n=arguments.length>=1?y.call(arguments,0):[],function(r,i,s){return{selector:{total:[[],[]],row:[i,[]],col:[[],s]}[t],inner:e.apply(null,n)(r,i,s),push:function(e){return this.inner.push(e)},format:function(e){return p(2)(100*e)+"%"},label:e.apply(null,n)(r,i,s).label+" % of "+t,value:function(){return this.inner.value()/r.getAggregator.apply(r,this.selector).inner.value()}}}}},l10nWrapper:function(e,t,n){return function(){var r;return r=arguments.length>=1?y.call(arguments,0):[],function(i,s,o){return{inner:e.apply(null,r)(i,s,o),push:function(e){return this.inner.push(e)},format:t,label:n(i),value:function(){return this.inner.value()}}}}}},i={count:function(){return function(){return{count:0,push:function(){return this.count++},value:function(){return this.count},format:p(0),label:"Count"}}},countUnique:function(e){var t;return t=e[0],function(){return{uniq:[],push:function(e){var n;return n=e[t],0>b.call(this.uniq,n)?this.uniq.push(e[t]):void 0},value:function(){return this.uniq.length},format:p(0),label:"Count Unique "+t}}},listUnique:function(e){var t;return t=e[0],function(){return{uniq:[],push:function(e){var n;return n=e[t],0>b.call(this.uniq,n)?this.uniq.push(e[t]):void 0},value:function(){return this.uniq.join(", ")},format:function(e){return e},label:"List Unique "+t}}},intSum:r.sum(0),sum:r.sum(3),average:r.average(3),sumOverSum:r.sumOverSum(3),ub80:r.sumOverSumBound80(3,1,!0),lb80:r.sumOverSumBound80(3,1,!1)},i.sumAsFractionOfTotal=r.fractionOf(i.sum),i.sumAsFractionOfRow=r.fractionOf(i.sum,"row"),i.sumAsFractionOfCol=r.fractionOf(i.sum,"col"),i.countAsFractionOfTotal=r.fractionOf(i.count),i.countAsFractionOfRow=r.fractionOf(i.count,"row"),i.countAsFractionOfCol=r.fractionOf(i.count,"col"),v={Table:function(e,t){return d(e,t)},"Table Barchart":function(e,t){return d(e,t).barchart()},Heatmap:function(e,t){return d(e,t).heatmap()},"Row Heatmap":function(e,t){return d(e,t).heatmap("rowheatmap")},"Col Heatmap":function(e,t){return d(e,t).heatmap("colheatmap")}},c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g=function(e){return("0"+e).substr(-2,2)},a={bin:function(e,t){return function(n){return n[e]-n[e]%t}},dateFormat:function(e,t){return function(n){var r;return r=new Date(Date.parse(n[e])),isNaN(r)?"":t.replace(/%(.)/g,function(e,t){switch(t){case"y":return r.getFullYear();case"m":return g(r.getMonth()+1);case"n":return c[r.getMonth()];case"d":return g(r.getDate());case"w":return o[r.getDay()];case"x":return r.getDay();case"H":return g(r.getHours());case"M":return g(r.getMinutes());case"S":return g(r.getSeconds());default:return"%"+t}})}}},h=function(e,t){var n,r,i,s,o,u,a;if(u=/(\d+)|(\D+)/g,o=/\d/,a=/^0/,"number"==typeof e||"number"==typeof t)return isNaN(e)?1:isNaN(t)?-1:e-t;if(n=(e+"").toLowerCase(),i=(t+"").toLowerCase(),n===i)return 0;if(!o.test(n)||!o.test(i))return n>i?1:-1;for(n=n.match(u),i=i.match(u);n.length&&i.length;)if(r=n.shift(),s=i.shift(),r!==s)return o.test(r)&&o.test(s)?r.replace(a,".0")-s.replace(a,".0"):r>s?1:-1;return n.length-i.length},e.pivotUtilities={aggregatorTemplates:r,aggregators:i,renderers:v,derivers:a,naturalSort:h,numberFormat:p},u=function(e,t,n){var r,i,s;for(r in t)i=t[r],e[r]=null!=(s=i(e))?s:e[r];for(r in e)E.call(e,r)&&null==e[r]&&(e[r]="null");return n(e)},f=function(t,n,r){var i,s,o,a,f,l,c,h,p,d,v,m;if(i=function(e){return u(e,n,r)},e.isFunction(t))return t(i);if(e.isArray(t)){if(e.isArray(t[0])){v=[];for(o in t)if(E.call(t,o)&&(s=t[o],o>0)){l={},d=t[0];for(a in d)E.call(d,a)&&(f=d[a],l[f]=s[a]);v.push(i(l))}return v}for(m=[],h=0,p=t.length;p>h;h++)l=t[h],m.push(i(l));return m}if(t instanceof jQuery)return c=[],e("thead > tr > th",t).each(function(t){return c.push(e(this).text())}),e("tbody > tr",t).each(function(t){return l={},e("td",this).each(function(t){return l[c[t]]=e(this).text()}),i(l)});throw Error("unknown input format")},s=function(e){var t;return t=[],f(e,{},function(e){return t.push(e)}),t},t=function(){function e(e,t,n){this.aggregator=e,this.colAttrs=t,this.rowAttrs=n,this.getAggregator=S(this.getAggregator,this),this.flattenKey=S(this.flattenKey,this),this.getRowKeys=S(this.getRowKeys,this),this.getColKeys=S(this.getColKeys,this),this.sortKeys=S(this.sortKeys,this),this.arrSort=S(this.arrSort,this),this.natSort=S(this.natSort,this),this.tree={},this.rowKeys=[],this.colKeys=[],this.flatRowKeys=[],this.flatColKeys=[],this.rowTotals={},this.colTotals={},this.allTotal=this.aggregator(this,[],[]),this.sorted=!1}return e.prototype.natSort=function(e,t){return h(e,t)},e.prototype.arrSort=function(e,t){return this.natSort(e.join(),t.join())},e.prototype.sortKeys=function(){return this.sorted||(this.rowKeys.sort(this.arrSort),this.colKeys.sort(this.arrSort)),this.sorted=!0},e.prototype.getColKeys=function(){return this.sortKeys(),this.colKeys},e.prototype.getRowKeys=function(){return this.sortKeys(),this.rowKeys},e.prototype.flattenKey=function(e){return e.join(String.fromCharCode(0))},e.prototype.processRecord=function(e){var t,n,r,i,s;return t=function(){var t,n,r,i;for(r=this.colAttrs,i=[],t=0,n=r.length;n>t;t++)s=r[t],i.push(e[s]);return i}.call(this),i=function(){var t,n,r,i;for(r=this.rowAttrs,i=[],t=0,n=r.length;n>t;t++)s=r[t],i.push(e[s]);return i}.call(this),r=this.flattenKey(i),n=this.flattenKey(t),this.allTotal.push(e),0!==i.length&&(0>b.call(this.flatRowKeys,r)&&(this.rowKeys.push(i),this.flatRowKeys.push(r)),this.rowTotals[r]||(this.rowTotals[r]=this.aggregator(this,i,[])),this.rowTotals[r].push(e)),0!==t.length&&(0>b.call(this.flatColKeys,n)&&(this.colKeys.push(t),this.flatColKeys.push(n)),this.colTotals[n]||(this.colTotals[n]=this.aggregator(this,[],t)),this.colTotals[n].push(e)),0!==t.length&&0!==i.length?(r in this.tree||(this.tree[r]={}),n in this.tree[r]||(this.tree[r][n]=this.aggregator(this,i,t)),this.tree[r][n].push(e)):void 0},e.prototype.getAggregator=function(e,t){var n,r,i;return i=this.flattenKey(e),r=this.flattenKey(t),n=0===e.length&&0===t.length?this.allTotal:0===e.length?this.colTotals[r]:0===t.length?this.rowTotals[i]:this.tree[i][r],null!=n?n:{value:function(){return null},format:function(){return""}}},e}(),l=function(e,n,r,i,s,o){var u;return u=new t(i,n,r),f(e,o,function(e){return s(e)?u.processRecord(e):void 0}),u},m=function(e,t,n){var r,i,s,o,u,a;if(0!==t){for(i=!0,o=u=0;n>=0?n>=u:u>=n;o=n>=0?++u:--u)e[t-1][o]!==e[t][o]&&(i=!1);if(i)return-1}for(r=0;e.length>t+r;){for(s=!1,o=a=0;n>=0?n>=a:a>=n;o=n>=0?++a:--a)e[t][o]!==e[t+r][o]&&(s=!0);if(s)break;r++}return r},d=function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,g,y,b,w,S,x;a={localeStrings:{totals:"Totals"}},n=e.extend(a,n),s=t.colAttrs,p=t.rowAttrs,v=t.getRowKeys(),u=t.getColKeys(),h=e("<table class='table table-bordered pvtTable'>");for(l in s)if(E.call(s,l)){i=s[l],b=e("<tr>"),0===parseInt(l)&&0!==p.length&&b.append(e("<th>").attr("colspan",p.length).attr("rowspan",s.length)),b.append(e("<th class='pvtAxisLabel'>").text(i));for(f in u)E.call(u,f)&&(o=u[f],x=m(u,parseInt(f),parseInt(l)),-1!==x&&(g=e("<th class='pvtColLabel'>").text(o[l]).attr("colspan",x),parseInt(l)===s.length-1&&0!==p.length&&g.attr("rowspan",2),b.append(g)));0===parseInt(l)&&b.append(e("<th class='pvtTotalLabel'>").text(n.localeStrings.totals).attr("rowspan",s.length+(0===p.length?0:1))),h.append(b)}if(0!==p.length){b=e("<tr>");for(f in p)E.call(p,f)&&(c=p[f],b.append(e("<th class='pvtAxisLabel'>").text(c)));g=e("<th>"),0===s.length&&g.addClass("pvtTotalLabel").text(n.localeStrings.totals),b.append(g),h.append(b)}for(f in v)if(E.call(v,f)){d=v[f],b=e("<tr>");for(l in d)E.call(d,l)&&(w=d[l],x=m(v,parseInt(f),parseInt(l)),-1!==x&&(g=e("<th class='pvtRowLabel'>").text(w).attr("rowspan",x),parseInt(l)===p.length-1&&0!==s.length&&g.attr("colspan",2),b.append(g)));for(l in u)E.call(u,l)&&(o=u[l],r=t.getAggregator(d,o),S=r.value(),b.append(e("<td class='pvtVal row"+f+" col"+l+"'>").html(r.format(S)).data("value",S)));y=t.getAggregator(d,[]),S=y.value(),b.append(e("<td class='pvtTotal rowTotal'>").html(y.format(S)).data("value",S).data("for","row"+f)),h.append(b)}b=e("<tr>"),g=e("<th class='pvtTotalLabel'>").text(n.localeStrings.totals),g.attr("colspan",p.length+(0===s.length?0:1)),b.append(g);for(l in u)E.call(u,l)&&(o=u[l],y=t.getAggregator([],o),S=y.value(),b.append(e("<td class='pvtTotal colTotal'>").html(y.format(S)).data("value",S).data("for","col"+l)));return y=t.getAggregator([],[]),S=y.value(),b.append(e("<td class='pvtGrandTotal'>").html(y.format(S)).data("value",S)),h.append(b),h.data("dimensions",[v.length,u.length]),h},e.fn.pivot=function(t,n){var r,s,o,u;r={cols:[],rows:[],filter:function(){return!0},aggregator:i.count(),derivedAttributes:{},renderer:d,rendererOptions:null,localeStrings:{renderError:"An error occurred rendering the PivotTable results.",computeError:"An error occurred computing the PivotTable results."}},n=e.extend(r,n),u=null;try{o=l(t,n.cols,n.rows,n.aggregator,n.filter,n.derivedAttributes);try{u=n.renderer(o,n.rendererOptions)}catch(a){s=a,"undefined"!=typeof console&&null!==console&&console.error(s.stack),u=n.localeStrings.renderError}}catch(a){s=a,"undefined"!=typeof console&&null!==console&&console.error(s.stack),u=n.localeStrings.computeError}return this.html(u),this},e.fn.pivotUI=function(t,n,r){var o,u,a,l,c,p,d,m,g,y,w,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J=this;null==r&&(r=!1),c={derivedAttributes:{},aggregators:i,renderers:v,hiddenAttributes:[],menuLimit:200,cols:[],rows:[],vals:[],exclusions:{},unusedAttrsVertical:!1,autoSortUnusedAttrs:!1,rendererOptions:null,onRefresh:null,filter:function(){return!0},localeStrings:{renderError:"An error occurred rendering the PivotTable results.",computeError:"An error occurred computing the PivotTable results.",uiRenderError:"An error occurred rendering the PivotTable UI.",selectAll:"Select All",selectNone:"Select None",tooMany:"(too many to list)"}},d=this.data("pivotUIOptions"),y=null==d||r?e.extend(c,n):d;try{t=s(t),k=function(){var e,n;e=t[0],n=[];for(g in e)E.call(e,g)&&n.push(g);return n}(),R=y.derivedAttributes;for(a in R)E.call(R,a)&&0>b.call(k,a)&&k.push(a);for(u={},D=0,j=k.length;j>D;D++)M=k[D],u[M]={};f(t,y.derivedAttributes,function(e){var t,n,r;r=[];for(g in e)E.call(e,g)&&(t=e[g],null==t&&(t="null"),null==(n=u[g])[t]&&(n[t]=0),r.push(u[g][t]++));return r}),O=e("<table class='table table-bordered' cellpadding='5'>"),N=e("<td>"),T=e("<select class='pvtRenderer'>").bind("change",function(){return S()}),U=y.renderers;for(M in U)E.call(U,M)&&T.append(e("<option>").val(M).text(M));N.append(T),l=e("<td class='pvtAxisContainer pvtUnused'>"),y.unusedAttrsVertical?l.addClass("pvtVertList"):l.addClass("pvtHorizList"),C=function(){var e,t,n;for(n=[],e=0,t=k.length;t>e;e++)a=k[e],0>b.call(y.hiddenAttributes,a)&&n.push(a);return n}(),_=function(t){var n,r,i,s,o,a,f,c,p,d,v,w,E,x,T;if(f=function(){var e;e=[];for(g in u[t])e.push(g);return e}(),a=!1,w=e("<div>").addClass("pvtFilterBox").css({"z-index":100,width:"280px",border:"1px solid gray",background:"white",display:"none",position:"absolute",padding:"20px"}),w.append(e("<div>").css({"text-align":"center","font-weight":"bold"}).text(""+t+" ("+f.length+")")),f.length>y.menuLimit)w.append(e("<p>").css({"text-align":"center"}).text(y.localeStrings.tooMany));else{for(r=e("<p>").css({"text-align":"center","margin-bottom":"5px"}),r.append(e("<button>").text(y.localeStrings.selectAll).bind("click",function(){return w.find("input").prop("checked",!0)})),r.append(e("<button>").text(y.localeStrings.selectNone).bind("click",function(){return w.find("input").prop("checked",!1)})),w.append(r),i=e("<div>").css({overflow:"scroll",width:"280px","max-height":"200px"}),T=f.sort(h),E=0,x=T.length;x>E;E++)g=T[E],v=u[t][g],s=e("<label>"),o=y.exclusions[t]?b.call(y.exclusions[t],g)>=0:!1,a||(a=o),s.append(e("<input type='checkbox' class='pvtFilter'>").attr("checked",!o).data("filter",[t,g])),s.append(e("<span>").text(""+g+" ("+v+")")),i.append(e("<p>").css("margin","5px").append(s));w.append(i)}return d=function(){var t;return t=e(w).find("[type='checkbox']").length-e(w).find("[type='checkbox']:checked").length,t>0?n.addClass("pvtFilteredAttribute"):n.removeClass("pvtFilteredAttribute"),f.length>y.menuLimit?w.toggle():w.toggle(0,S)},w.append(e("<p>").css({"text-align":"center","margin-bottom":0}).append(e("<button>").text("OK").bind("click",d))),c=function(e){return w.css({left:e.pageX,top:e.pageY}).toggle()},p=e("<span class='pvtTriangle'>").html(" &#x25BE;").bind("click",c),n=e("<li class='label label-info axis_"+m+"'>").append(e("<nobr>").text(t).data("attrName",t).append(p)),a&&n.addClass("pvtFilteredAttribute"),l.append(n).append(w),n.bind("dblclick",c)};for(m in C)a=C[m],_(a);L=e("<tr>"),o=e("<select class='pvtAggregator'>").css("margin-bottom","5px").bind("change",function(){return S()}),z=y.aggregators;for(M in z)E.call(z,M)&&o.append(e("<option>").val(M).text(M));for(L.append(e("<td class='pvtAxisContainer pvtHorizList pvtVals'>").css("text-align","center").append(o).append(e("<br>"))),L.append(e("<td class='pvtAxisContainer pvtHorizList pvtCols'>")),O.append(L),A=e("<tr>"),A.append(e("<td valign='top' class='pvtAxisContainer pvtRows'>")),w=e("<td valign='top' class='pvtRendererArea'>"),A.append(w),O.append(A),y.unusedAttrsVertical?(O.find("tr:nth-child(1)").prepend(N),O.find("tr:nth-child(2)").prepend(l.css("vertical-align","top"))):O.prepend(e("<tr>").append(N).append(l)),this.html(O),W=y.cols,P=0,F=W.length;F>P;P++)M=W[P],this.find(".pvtCols").append(this.find(".axis_"+C.indexOf(M)));for(X=y.rows,H=0,I=X.length;I>H;H++)M=X[H],this.find(".pvtRows").append(this.find(".axis_"+C.indexOf(M)));for(V=y.vals,B=0,q=V.length;q>B;B++)M=V[B],this.find(".pvtVals").append(this.find(".axis_"+C.indexOf(M)));null!=y.aggregatorName&&this.find(".pvtAggregator").val(y.aggregatorName),null!=y.rendererName&&this.find(".pvtRenderer").val(y.rendererName),x=function(){var n,r,i,s,u;return i={derivedAttributes:y.derivedAttributes,localeStrings:y.localeStrings,rendererOptions:y.rendererOptions,cols:[],rows:[]},u=[],J.find(".pvtRows li nobr").each(function(){return i.rows.push(e(this).data("attrName"))}),J.find(".pvtCols li nobr").each(function(){return i.cols.push(e(this).data("attrName"))}),J.find(".pvtVals li nobr").each(function(){return u.push(e(this).data("attrName"))}),i.aggregator=y.aggregators[o.val()](u),i.renderer=y.renderers[T.val()],n={},J.find("input.pvtFilter").not(":checked").each(function(){var t;return t=e(this).data("filter"),console.log(t),null!=n[t[0]]?n[t[0]].push(t[1]):n[t[0]]=[t[1]]}),i.filter=function(e){var t,r;if(!y.filter(e))return!1;for(g in n)if(t=n[g],r=""+e[g],b.call(t,r)>=0)return!1;return!0},w.pivot(t,i),J.data("pivotUIOptions",{cols:i.cols,rows:i.rows,vals:u,exclusions:n,hiddenAttributes:y.hiddenAttributes,renderers:y.renderers,aggregators:y.aggregators,filter:y.filter,derivedAttributes:y.derivedAttributes,aggregatorName:o.val(),rendererName:T.val(),localeStrings:y.localeStrings,rendererOptions:y.rendererOptions}),y.autoSortUnusedAttrs&&(r=e.pivotUtilities.naturalSort,s=J.find("td.pvtUnused.pvtAxisContainer"),e(s).children("li").sort(function(t,n){return r(e(t).text(),e(n).text())}).appendTo(s)),w.css("opacity",1),null!=y.onRefresh?y.onRefresh():void 0},S=function(){return w.css("opacity",.5),setTimeout(x,10)},S(),this.find(".pvtAxisContainer").sortable({update:S,connectWith:this.find(".pvtAxisContainer"),items:"li",placeholder:"placeholder"})}catch(K){p=K,"undefined"!=typeof console&&null!==console&&console.error(p.stack),this.html(y.localeStrings.uiRenderError)}return this},e.fn.heatmap=function(t){var n,r,i,s,o,u,a,f,l,c=this;switch(null==t&&(t="heatmap"),l=this.data("dimensions"),u=l[0],o=l[1],n=function(e,t,n){var r;return r=function(){switch(e){case"red":return function(e){return"ff"+e+e};case"green":return function(e){return""+e+"ff"+e};case"blue":return function(e){return""+e+e+"ff"}}}(),function(e){var i,s;return s=255-Math.round(255*(e-t)/(n-t)),i=s.toString(16).split(".")[0],1===i.length&&(i=0+i),r(i)}},r=function(t,r){var i,s,o;return s=function(n){return c.find(t).each(function(){var t;return t=e(this).data("value"),null!=t&&isFinite(t)?n(t,e(this)):void 0})},o=[],s(function(e){return o.push(e)}),i=n(r,Math.min.apply(Math,o),Math.max.apply(Math,o)),s(function(e,t){return t.css("background-color","#"+i(e))})},t){case"heatmap":r(".pvtVal","red");break;case"rowheatmap":for(i=a=0;u>=0?u>a:a>u;i=u>=0?++a:--a)r(".pvtVal.row"+i,"red");break;case"colheatmap":for(s=f=0;o>=0?o>f:f>o;s=o>=0?++f:--f)r(".pvtVal.col"+s,"red")}return r(".pvtTotal.rowTotal","red"),r(".pvtTotal.colTotal","red"),this},e.fn.barchart=function(){var t,n,r,i,s,o,u=this;for(o=this.data("dimensions"),i=o[0],r=o[1],t=function(t){var n,r,i,s;return n=function(n){return u.find(t).each(function(){var t;return t=e(this).data("value"),null!=t&&isFinite(t)?n(t,e(this)):void 0})},s=[],n(function(e){return s.push(e)}),r=Math.max.apply(Math,s),i=function(e){return 100*e/(1.4*r)},n(function(t,n){var r,s;return r=n.text(),s=e("<div>").css({position:"relative",height:"55px"}),s.append(e("<div>").css({position:"absolute",bottom:0,left:0,right:0,height:i(t)+"%","background-color":"gray"})),s.append(e("<div>").text(r).css({position:"relative","padding-left":"5px","padding-right":"5px"})),n.css({padding:0,"padding-top":"5px","text-align":"center"}).html(s)})},n=s=0;i>=0?i>s:s>i;n=i>=0?++s:--s)t(".pvtVal.row"+n);return t(".pvtTotal.colTotal"),this}}).call(this);

            Rally.launchApp('CustomApp', {
                name:"portfolio-pivot-table",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
    <style type="text/css">
        table.pvtTable{font-family:arial;font-size:8pt;text-align:left;border-collapse:collapse}table.pvtTable tr th,table.pvtTable tr th{background-color:#e6EEEE;border:1px solid #CDCDCD;font-size:8pt;padding:5px}table.pvtTable .pvtColLabel{text-align:center}table.pvtTable .pvtTotalLabel{text-align:right}table.pvtTable tr td{color:#3D3D3D;padding:5px;background-color:#FFF;border:1px solid #CDCDCD;vertical-align:top;text-align:right}.pvtTotal,.pvtGrandTotal{font-weight:bold}.pvtAxisContainer{border:1px solid gray;background:#EEE;padding:5px;min-width:20px;min-height:20px}.pvtAxisContainer li{padding:8px 6px;list-style-type:none;cursor:move}.pvtAxisContainer li.placeholder{-webkit-border-radius:5px;padding:3px 15px;-moz-border-radius:5px;border-radius:5px;border:1px dashed #aaa}.pvtAxisContainer li nobr{background:#F3F3F3;border:1px solid #DEDEDE;padding:2px 5px;-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px}.pvtTriangle{cursor:pointer;color:grey}.pvtHorizList li{display:inline}.pvtFilteredAttribute{font-style:italic}
    </style>
</head>
<body>
</body>
</html>
