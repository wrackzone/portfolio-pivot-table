<!DOCTYPE html>
<html>
<head>
    <title>portfolio-pivot-table</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://c9.io/bazzert/cycle-time-by-state/workspace/lib/pivot.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null,types=["PortfolioItem/Feature"];Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this;var panel=Ext.create("Ext.container.Container",{itemId:"panel",title:"Hello",width:800,height:600,html:"<p></p>"});this.add(panel);var p=this.down("#panel");app.jqPanel="#"+p.id,app.mask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.mask.show(),this.readPortfolioItems()},createConfigForPortfolioType:function(type){return{fetch:["Name","_UnformattedID","ObjectID","_TypeHierarchy","c_STO","_ItemHierarchy","InvestmentCategory","PortfolioItemType","State","Owner"],hydrate:["_TypeHierarchy","State","PortfolioItemType","InvestmentCategory"],pageSize:1e3,find:{_TypeHierarchy:{$in:[type]},_ProjectHierarchy:{$in:app.getContext().getProject().ObjectID},__At:"current"}}},readPortfolioItems:function(){var configs=_.map(types,function(type){return app.createConfigForPortfolioType(type)});async.mapSeries(configs,app.readSnapshots,function(err,results){console.log("results",results),app.addThemesToFeatures(results[0])})},addThemesToFeatures:function(features){var themeIds=_.map(features,function(f){var ih=f.get("_ItemHierarchy");return 3===ih.length?ih[0]:null});themeIds=_.compact(themeIds),themeIds=_.uniq(themeIds),console.log("distinct themes",themeIds);var themeConfig={fetch:["Name","_UnformattedID","ObjectID","_TypeHierarchy","c_STO","_ItemHierarchy","InvestmentCategory","PortfolioItemType","State","Owner"],hydrate:["_TypeHierarchy","State","PortfolioItemType","InvestmentCategory"],pageSize:1e3,find:{_TypeHierarchy:{$in:["PortfolioItem/Theme"]},__At:"current"}};async.mapSeries([themeConfig],app.readSnapshots,function(err,results){app.themes=results[0],_.each(features,function(f){var th=f.get("_ItemHierarchy");if(3===th.length){var themeid=th[0],theme=_.find(app.themes,function(t){return t.get("ObjectID")===themeid});f.set("Theme",theme.get("Name"))}else f.set("Theme","")}),app.addOwners(features)})},addOwners:function(features){var ownerIds=_.map(features,function(f){var o=f.get("Owner");return void 0!==o&&null!==o?o:null});ownerIds=_.compact(ownerIds),ownerIds=_.uniq(ownerIds),console.log("distinct owners",ownerIds);var configs=_.map(ownerIds,function(o){return{model:"User",fetch:["UserName","DisplayName"],filters:[{property:"ObjectID",value:o}]}});async.map(configs,app.wsapiQuery,function(err,results){app.owners=_.pluck(results,function(r){return r[0]}),app.owners=_.compact(app.owners),console.log("owners",app.owners),_.each(features,function(f){var ownerName=_.find(app.owners,function(o){return o.get("ObjectID")===f.get("Owner")});void 0!==ownerName&&null!==ownerName?f.set("OwnerName",null!==ownerName.get("DisplayName")&&ownerName.get("DisplayName").length>0?ownerName.get("DisplayName"):ownerName.get("UserName")):f.set("OwnerName","")}),app.pivotTable(features)})},pivotTable:function(features){var data=_.map(features,function(s){return s.data});$(app.jqPanel).pivotUI(data,{rows:["Theme"],cols:["InvestmentCategory"],hiddenAttributes:["Owner","ObjectID","_TypeHierarchy","_UnformattedID","_ValidFrom","_ValidTo","PortfolioItemType","_ItemHierarchy"]}),app.mask.hide()},readSnapshots:function(config,callback){console.log("reading page of snapshots...");var storeConfig={find:config.find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:config.fetch,hydrate:config.hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});

            Rally.launchApp('CustomApp', {
                name:"portfolio-pivot-table",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
    <style type="text/css">
        
table.pvtTable {
    font-family:arial;
    font-size: 8pt;
    text-align: left;
    border-collapse: collapse;
}
table.pvtTable tr th, table.pvtTable tr th {
    background-color: #e6EEEE;
    border: 1px solid #CDCDCD;
    font-size: 8pt;
    padding: 5px;
}

table.pvtTable .pvtColLabel {text-align: center;}
table.pvtTable .pvtTotalLabel {text-align: right;}

table.pvtTable tr td {
    color: #3D3D3D;
    padding: 5px;
    background-color: #FFF;
    border: 1px solid #CDCDCD;
    vertical-align: top;
    text-align: right;
}

.pvtTotal, .pvtGrandTotal { font-weight: bold; }

.pvtAxisContainer {
    border: 1px solid gray;
    background: #EEE;
    padding: 5px;
    min-width: 20px;
    min-height: 20px;
}
.pvtAxisContainer li {
    margin: 5px;
    padding: 5px;
    list-style-type: none;
    cursor:move;
}

.pvtHorizList li { display: inline; }

    </style>
</head>
<body></body>
</html>
